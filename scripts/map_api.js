mapboxgl.accessToken = 'pk.eyJ1Ijoic3ByaW5nYyIsImEiOiJjbHRnOGc4dW8wd2o2MmxvNmN2NzRubnI3In0.njs3h0TJg9FhtoClPB9ovQ';
const map = new mapboxgl.Map({
  container: 'map',
  // style: 'mapbox://styles/mapbox/light-v11',
  style: 'mapbox://styles/springc/clu04eey3022g01pt6hymd9aa',
  center: [-123.112755, 49.241722],
  zoom: 10
});

map.on('load', () => {
  // Add a data source containing GeoJSON data.
  map.addSource('Dunbar-Southlands', {
    'type': 'geojson',
    'data': {
      'type': 'Feature',
      'geometry': {
        'type': 'Polygon',
        'coordinates': [
          [
            [
              -123.17016601562501,
              49.24789047147971
            ],
            [
              -123.17024993896484,
              49.234703063032356
            ],
            [
              -123.17870330810548,
              49.234722136518705
            ],
            [
              -123.17909240722656,
              49.21680450346197
            ],
            [
              -123.17908477783203,
              49.21555709745609
            ],
            [
              -123.17910003662108,
              49.21555709745609
            ],
            [
              -123.17975616455078,
              49.21558761503423
            ],
            [
              -123.18041229248047,
              49.21563720609868
            ],
            [
              -123.18106079101561,
              49.215713500044004
            ],
            [
              -123.18170166015624,
              49.215812682172896
            ],
            [
              -123.18232727050781,
              49.2159347524854
            ],
            [
              -123.18295288085936,
              49.2160797109815
            ],
            [
              -123.18355560302734,
              49.216247557661184
            ],
            [
              -123.18415069580078,
              49.21643447782719
            ],
            [
              -123.18472290039062,
              49.216644286176795
            ],
            [
              -123.1852798461914,
              49.216873168012754
            ],
            [
              -123.18581390380858,
              49.21712112333501
            ],
            [
              -123.1863327026367,
              49.21739196684088
            ],
            [
              -123.18682098388672,
              49.2176780691358
            ],
            [
              -123.18728637695314,
              49.21797943021979
            ],
            [
              -123.18772888183592,
              49.21829986479009
            ],
            [
              -123.18795013427734,
              49.218463896772526
            ],
            [
              -123.18818664550781,
              49.218616484663144
            ],
            [
              -123.18843841552733,
              49.218761443159245
            ],
            [
              -123.18869781494139,
              49.2188987722608
            ],
            [
              -123.18896484375001,
              49.219024657270566
            ],
            [
              -123.18924713134767,
              49.219142912885786
            ],
            [
              -123.18953704833984,
              49.21924972440924
            ],
            [
              -123.18983459472655,
              49.219348906538166
            ],
            [
              -123.19014739990236,
              49.21943282987801
            ],
            [
              -123.19046020507812,
              49.21950912382332
            ],
            [
              -123.1907730102539,
              49.219573973676816
            ],
            [
              -123.19110107421875,
              49.21962356474128
            ],
            [
              -123.1975860595703,
              49.22055435087409
            ],
            [
              -123.19785308837892,
              49.22060012724128
            ],
            [
              -123.19811248779298,
              49.220653533002995
            ],
            [
              -123.1983642578125,
              49.22071838285651
            ],
            [
              -123.19861602783203,
              49.22079086210457
            ],
            [
              -123.1988525390625,
              49.220874785444394
            ],
            [
              -123.19908905029297,
              49.22096633817878
            ],
            [
              -123.19931793212892,
              49.22106170561042
            ],
            [
              -123.1995315551758,
              49.22116851713387
            ],
            [
              -123.19974517822267,
              49.221282958051845
            ],
            [
              -123.19994354248047,
              49.22140502836434
            ],
            [
              -123.20550537109374,
              49.224994658491305
            ],
            [
              -123.20590972900389,
              49.225299834272555
            ],
            [
              -123.20629119873048,
              49.225616454145595
            ],
            [
              -123.20664215087889,
              49.225944518110445
            ],
            [
              -123.20697021484374,
              49.22628784086436
            ],
            [
              -123.20726776123047,
              49.2266387930128
            ],
            [
              -123.20754241943358,
              49.22700118925303
            ],
            [
              -123.20888519287108,
              49.22894668485851
            ],
            [
              -123.20916748046875,
              49.2292594900343
            ],
            [
              -123.20948028564452,
              49.22956085111828
            ],
            [
              -123.20982360839844,
              49.22984695341319
            ],
            [
              -123.2101821899414,
              49.230121611616326
            ],
            [
              -123.21057128906251,
              49.23038101103039
            ],
            [
              -123.21098327636719,
              49.230625151655396
            ],
            [
              -123.21141815185545,
              49.23085403349131
            ],
            [
              -123.21985626220702,
              49.235023497602675
            ],
            [
              -123.2219467163086,
              49.23657607938979
            ],
            [
              -123.21992492675781,
              49.23954772855973
            ],
            [
              -123.2085952758789,
              49.235183714887846
            ],
            [
              -123.20560455322267,
              49.23720168974136
            ],
            [
              -123.1968307495117,
              49.23485565092299
            ],
            [
              -123.1968536376953,
              49.23651504423354
            ],
            [
              -123.19857025146484,
              49.236518858930815
            ],
            [
              -123.19857025146484,
              49.23834609892106
            ],
            [
              -123.1968536376953,
              49.23847961332534
            ],
            [
              -123.19678497314452,
              49.246196745893755
            ],
            [
              -123.19854736328125,
              49.246208189985545
            ],
            [
              -123.19858551025392,
              49.246208189985545
            ],
            [
              -123.19863128662111,
              49.246208189985545
            ],
            [
              -123.1986770629883,
              49.2462120046828
            ],
            [
              -123.19871520996094,
              49.246215819380076
            ],
            [
              -123.19876098632812,
              49.24622344877462
            ],
            [
              -123.1987991333008,
              49.24623107816914
            ],
            [
              -123.19884490966798,
              49.24623870756366
            ],
            [
              -123.19888305664062,
              49.246246336958194
            ],
            [
              -123.19892120361328,
              49.24625778105002
            ],
            [
              -123.19895935058592,
              49.24627303983906
            ],
            [
              -123.1989974975586,
              49.246288298628116
            ],
            [
              -123.19903564453126,
              49.24629974271992
            ],
            [
              -123.19906616210938,
              49.246318816206255
            ],
            [
              -123.20494079589842,
              49.24926376249533
            ],
            [
              -123.2009963989258,
              49.249973296186745
            ],
            [
              -123.20079040527344,
              49.25001144315941
            ],
            [
              -123.20057678222656,
              49.25003814604025
            ],
            [
              -123.20036315917969,
              49.25005721952656
            ],
            [
              -123.20014190673827,
              49.25006866361837
            ],
            [
              -123.19992828369139,
              49.25007247831563
            ],
            [
              -123.1986770629883,
              49.25007629301293
            ],
            [
              -123.1986770629883,
              49.249923705122285
            ],
            [
              -123.19660949707031,
              49.24992751981954
            ],
            [
              -123.19654846191405,
              49.25651931669457
            ],
            [
              -123.20288085937499,
              49.25661468412623
            ],
            [
              -123.20321655273439,
              49.258148192427015
            ],
            [
              -123.18399047851561,
              49.257865904829366
            ],
            [
              -123.17807006835938,
              49.25776672270045
            ],
            [
              -123.1781005859375,
              49.257164000532484
            ],
            [
              -123.17792510986328,
              49.2569389333938
            ],
            [
              -123.17616271972656,
              49.25561141874535
            ],
            [
              -123.17501068115233,
              49.25408172514183
            ],
            [
              -123.17347717285158,
              49.252849577925026
            ],
            [
              -123.1718978881836,
              49.25154495146018
            ],
            [
              -123.1696014404297,
              49.24896240141134
            ],
            [
              -123.17092895507812,
              49.24967193510274
            ],
            [
              -123.17218780517578,
              49.250045775434785
            ],
            [
              -123.17095184326172,
              49.24844741728048
            ],
            [
              -123.17051696777342,
              49.248092650434785
            ],
            [
              -123.17016601562501,
              49.24789047147971
            ]
          ]
        ]
      }
    }
  });
  // Add a new layer to visualize the polygon.
  map.addLayer({
    'id': 'Dunbar-Southlands',
    'type': 'fill',
    'source': 'Dunbar-Southlands', // reference the data source
    'layout': {},
    'paint': {
      'fill-color': '#0080ff', // blue color fill
      'fill-opacity': 0.5
    }
  });

  // Add a black outline around the polygon.
  map.addLayer({
    'id': 'outline',
    'type': 'line',
    'source': 'Dunbar-Southlands',
    'layout': {},
    'paint': {
      'line-color': '#000',
      'line-width': 3
    }
  });
});

map.on('click', (event) => {
  // If the user clicked on one of the markers, get its information.
  const features = map.queryRenderedFeatures(event.point, {
    layers: ['neighbourhoods']
  });
  if (!features.length) {
    return;
  }
  const feature = features[0];

  const popup = new mapboxgl.Popup({ offset: [0, -15] })
    .setLngLat(feature.geometry.coordinates)
    .setHTML(
      `<h3>${feature.properties.title}</h3><p>${feature.properties.description}</p>`
    )
    .addTo(map);
});

const geocoder = new MapboxGeocoder({
  // Initialize the geocoder
  accessToken: mapboxgl.accessToken,
  mapboxgl: mapboxgl,
  marker: false,
  placeholder: 'Search for neighbourhood', // Placeholder text for the search bar
  bbox: [-123.2460, 49.1666, -123.0724, 49.3200], // Boundary for Metro Vancouver
  proximity: {
    longitude: -123.1207,
    latitude: 49.2827
  } // Coordinates of Central Vancouver
});

// Add the geocoder to the map
map.addControl(geocoder);

// After the map style has loaded on the page,
// add a source layer and default styling for a single point
map.on('load', () => {
  map.addSource('single-point', {
    type: 'geojson',
    data: {
      type: 'FeatureCollection',
      features: []
    }
  });

  map.addLayer({
    id: 'point',
    source: 'single-point',
    type: 'circle',
    paint: {
      'circle-radius': 10,
      'circle-color': '#448ee4'
    }
  });

  // Listen for the result event from the Geocoder
  // result event is triggered when a user makes a selection
  // Add a marker at the result's coordinates
  geocoder.on('result', (event) => {
    map.getSource('single-point').setData(event.result.geometry);
  });
});

// add markers to map
for (const feature of geojson.features) {
  // create a HTML element for each feature
  const el = document.createElement('div');
  el.className = 'marker';

  // make a marker for each feature and add to the map
  new mapboxgl.Marker(el).setLngLat(feature.geometry.coordinates).addTo(map);
}

new mapboxgl.Marker(el)
  .setLngLat(feature.geometry.coordinates)
  .setPopup(
    new mapboxgl.Popup({ offset: 25 }) // add popups
      .setHTML(
        `<h3>${feature.properties.title}</h3><p>${feature.properties.description}</p>`
      )
  )
  .addTo(map);
